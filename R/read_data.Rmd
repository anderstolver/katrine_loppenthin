---
title: "Read data and tidy up data"
author: "Anders Tolver"
date: "21 Mar 2018"
output: 
  html_document:
    keep_md: TRUE
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
```

# Read in data

Kathrine Bjerre Løppenthin provided the following data files for the project

```{r}
list.files(path = "../data")
```

## Randomisation list

```{r}
data_rand_list <- read_excel(path  = "../data/Intervention og kontrol.xlsx"
                   , sheet = 1)
```

## Baseline data

Excel file containing 9 sheets. 

First (=anamnese) and last (=Søvndagbog) sheets are  empty?

Use instead files `Anamnese_baseline_followup.xls` and `Kopi af Indtast søvndagbog.xls`.

```{r}
data_base_psqi <- read_excel(path  = "../data/Baseline data.xls", skip = 1
                   , sheet = 2)
data_base_ess <- read_excel(path  = "../data/Baseline data.xls", skip = 1
                   , sheet = 3)
data_base_bristol <- read_excel(path  = "../data/Baseline data.xls", skip = 1
                   , sheet = 4)
data_base_fys_akt <- read_excel(path  = "../data/Baseline data.xls", skip = 1
                   , sheet = 5)
data_base_dep <- read_excel(path  = "../data/Baseline data.xls", skip = 1
                   , sheet = 6)
data_base_fys_funk <- read_excel(path  = "../data/Baseline data.xls", skip = 1
                   , sheet = 7)
data_base_eq_5d <- read_excel(path  = "../data/Baseline data.xls", skip = 1
                   , sheet = 8)

```

## Follow up

Note that `.` and blanks have been used to indicate  missing values ...

```{r}
data_follow_psqi <- read_excel(path  = "../data/Follow-up data.xls", skip = 1
                   , sheet = 1)
data_follow_ess <- read_excel(path  = "../data/Follow-up data.xls", skip = 1, na = "."
                   , sheet = 2)
data_follow_bristol <- read_excel(path  = "../data/Follow-up data.xls", skip = 1, na = "."
                   , sheet = 3)
data_follow_fys_akt <- read_excel(path  = "../data/Follow-up data.xls", skip = 1
                   , sheet = 4)
data_follow_dep <- read_excel(path  = "../data/Follow-up data.xls", skip = 1
                   , sheet = 5)
data_follow_fys_funk <- read_excel(path  = "../data/Follow-up data.xls", skip = 1
                   , sheet = 6)
data_follow_eq5d <- read_excel(path  = "../data/Follow-up data.xls", skip = 1
                   , sheet = 7)
```

## Anamnese (Baseline + follow up)

```{r}
data_base_anamnese <- read_excel(path  = "../data/Anamnese_baseline_followup.xls", sheet = 1)
data_follow_anamnese <- read_excel(path  = "../data/Anamnese_baseline_followup.xls", sheet = 2)
```

Renaming variables according to key provided by Kathrine (see file `Variabeloversigt`).

```{r}
data_base_anamnese <- plyr::rename(data_base_anamnese
             , replace = c("age" = "Age", "tend_joi" = "Tend_joi"
                           , "job" = "Job", "smoking" = "Smoking") )
data_follow_anamnese <- plyr::rename(data_follow_anamnese
             , replace = c("tend_joi" = "Tend_joi"
                           , "Koffein" = "koffein") )
names(data_base_anamnese)
names(data_follow_anamnese)
```


## S-dagbog (Baseline + follow up)

# Construction of new variables

## PSQI

Consult `scoringsmanual til PSQI.pdf`

```{r}
data_base_psqi
```

## 3. Epworth Sleepiness Scale (ESS)

### Check raw data values (baseline + follow up)

All items with take data values 0-3

```{r}
apply(data_base_ess[, -1], 2, table)
apply(data_follow_ess[, -1], 2, table)
```

Count number of missing values 

```{r}
apply(data_base_ess[, 1 + 1:8], 2, function(z){sum(is.na(z))})
apply(data_follow_ess[, 1 + 1:8], 2, function(z){sum(is.na(z))})

```

### Compute ESS sum score

```{r}
data_base_ess$total <- apply(data_base_ess[, 1 + 1:8], 1, sum)
data_follow_ess$total <- apply(data_follow_ess[, 1 + 1:8], 1, sum)

summary(data_base_ess$total)
summary(data_follow_ess$total)
```


## 4. Bristol (BRAF)

### Check  raw data values (baseline)

Range of `SP4_Spg_1_BA` should be 0-10

```{r}
table(data_base_bristol[, 1 + 1])
```

Range of `SP4_Spg_2_BA` should be 0-7

```{r}
table(data_base_bristol[, 1 + 2])
```

Range of `SP4_Spg_3_BA` should be 0-2

```{r}
table(data_base_bristol[, 1 + 3])
```

Range of `SP4_Spg_5_BA- SP4_Spg_20_BA` should be 0-3

```{r}
raw_tab <- apply(data_base_bristol[, 1 + 4:20], 2, table)
raw_tab
```

### Check  raw data values (follow up)

Range of `SP4_Spg_1_BA` should be 0-10

```{r}
table(data_follow_bristol[, 1 + 1])
```

Range of `SP4_Spg_2_BA` should be 0-7

```{r}
table(data_follow_bristol[, 1 + 2])
```

Range of `SP4_Spg_3_BA` should be 0-2

```{r}
table(data_follow_bristol[, 1 + 3])
```

Range of `SP4_Spg_5_BA- SP4_Spg_20_BA` should be 0-3

```{r}
raw_tab <- apply(data_follow_bristol[, 1 + 4:20], 2, table)
raw_tab
```

Be careful how to handle NAs ...

Tabulate number of NAs

```{r} 
```

### Compute sum scores from BRAF

```{r}
get_psqi_phys <- function(x){
  m_score <- c(10, 7, 2, 3)
  na_pos <- is.na(x)
  res <- sum(x, na.rm = T)/sum(m_score[!na_pos]) * sum(m_score)
  if((sum(na_pos) > 1)||(any(is.na(x[1:2])))){res <- NA}
  return(res)
}

data_base_bristol$BRAF_phys <- apply(data_base_bristol[2:5], 1, get_psqi_phys)

get_psqi_other <- function(x){
  m_score <- rep(3, length(x))
  na_pos <- is.na(x)
  res <- sum(x, na.rm = T)/sum(m_score[!na_pos]) * sum(m_score)
  if((sum(na_pos) > 1)){res <- NA}
  return(res)
}

data_base_bristol$BRAF_living <- apply(data_base_bristol[, 1 + 5:11], 1, get_psqi_other)
data_base_bristol$BRAF_cog <- apply(data_base_bristol[, 1 + 12:16], 1, get_psqi_other)
data_base_bristol$BRAF_emo <- apply(data_base_bristol[, 1 + 17:20], 1, get_psqi_other)
data_base_bristol$BRAF_total <- apply(dplyr::select(data_base_bristol, dplyr::contains("BRAF")), 1, sum)

data_follow_bristol$BRAF_phys <- apply(data_follow_bristol[2:5], 1, get_psqi_phys)

get_psqi_other <- function(x){
  m_score <- rep(3, length(x))
  na_pos <- is.na(x)
  res <- sum(x, na.rm = T)/sum(m_score[!na_pos]) * sum(m_score)
  if((sum(na_pos) > 1)){res <- NA}
  return(res)
}

data_follow_bristol$BRAF_living <- apply(data_follow_bristol[, 1 + 5:11], 1, get_psqi_other)
data_follow_bristol$BRAF_cog <- apply(data_follow_bristol[, 1 + 12:16], 1, get_psqi_other)
data_follow_bristol$BRAF_emo <- apply(data_follow_bristol[, 1 + 17:20], 1, get_psqi_other)
data_follow_bristol$BRAF_total <- apply(dplyr::select(data_follow_bristol, dplyr::contains("BRAF")), 1, sum)

```

```{r}
summary(data_base_bristol$BRAF_phys)
summary(data_base_bristol$BRAF_living)
summary(data_base_bristol$BRAF_cog)
summary(data_base_bristol$BRAF_emo)
summary(data_base_bristol$BRAF_total)

summary(data_follow_bristol$BRAF_phys)
summary(data_follow_bristol$BRAF_living)
summary(data_follow_bristol$BRAF_cog)
summary(data_follow_bristol$BRAF_emo)
summary(data_follow_bristol$BRAF_total)
```

